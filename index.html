<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

	<link rel="stylesheet" type="text/css" href="layout.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="./jquery-ui.min.css">

	<!--<script src="./jquery.js"></script>-->

	<script type="text/javascript" src="./jquery.min.js"></script>
	<script type="text/javascript" src="./jquery-ui.min.js"></script>
	<!--<script type="text/javascript" src="client-rpc.js"></script>-->
	<!--<script type="text/javascript" src="js/bootstrap.min.js"></script>-->

    <title>BREATHING_RESISTANCE_ANALYSIS</title>
  </head>

  <body>
    <div class='container'>
      <div id='header' class='row' style='display:none'>
    	<table id='gearData' class='table'>
    		<tr>
    			<td style='text-align:right'>GEAR:</td>
    			<td><input id='gearInput' type='text' name='enteredGear' placeholder='required field...'/></td>
    		</tr>
    		<tr>
    			<td style='text-align:right; white-space:nowrap'>SERVICE DATE:</td>
    			<td><input type="text" id="datepicker"></td>
    		</tr>
    		<tr>
    			<td style='text-align:right'>TECHNICIAN:</td>
    			<td>
    				<select id='selectTechnician' class='form-control'>
    					<option value='Gintautas Krakauskas'>Gintautas Krakauskas</option>
    					<option value='Valiera'>Direktorius Valiera</option>
    				</select>
    			</td>
    		</tr>
    	</table>
    	<div id='nextService' class='well'>
    		<p>FOLOWING SERVICE</p>
    		<p id='nextServiceDate'></p>
    	</div>
    	<table id='buttons' style='position: absolute; right: 31px; top: 95px; z-index: 2'>
    		<tr>
    			<td><button style='display: none' id='jpgButton' class='printButtons btn btn-xs btn-success' type="button">Print .jpg</button></td>
    			<td><button style='display: none' id='pdfButton' class='printButtons btn btn-xs btn-success' type="button" onclick="printPDF()">Print .pdf</button></td>
    			<td><button style='display: none' id='printButton' class='printButtons btn btn-xs btn-success' type="button" onclick="printOnPrinter()">Print</button></td>
    		</tr>
    	</table>
      </div>
      <canvas id="myChart" width="400" height="400"></canvas>
      <table id='footer' class='footer' style='display: none'></table>
    </div>
  </body>

  <script>
    // You can also require other files to run in this process
    require('./renderer.js');
	var Chart = require('chart.js');
	var LineByLineReader = require('line-by-line');
	var form = require('./form.js');
	var {dialog} = require('electron').remote;
	var buttonsManager = require('./ButtonsHandler.js');
  const {ipc} = require('electron');
	var exec = require('child_process').exec;


  const {ipcRenderer} = require('electron')
//console.log(ipcRenderer.sendSync('synchronous-message', 'ping')) // prints "pong"
/*
ipcRenderer.on('asynchronous-reply', (event, arg) => {
  console.log(arg) // prints "pong"
})
*/
  // PDF PRINT DONE INDICATOR
  ipcRenderer.on('PrintDone', function() {
	$('#buttons').show();
  });
  
  
  function printPDF() {
	$('#buttons').hide();
	ipcRenderer.send('printPdf');
  }

  function printOnPrinter() {
	$('#buttons').hide();
    ipcRenderer.send('print');
  }




	var contentDisplayObjects = new Array($('#header'), $('#footer'));

	dialog.showOpenDialog({properties: ['openFile', 'singleSelection'], filters: [{name:'', extensions:['txt']}]}, function(file) {
		console.log(file)
		lineCounter = 0;
		MeasureData = new Array();

		if(file) {
			lr = new LineByLineReader(file[0]);
			contentDisplayObjects.forEach(function(obj) {
				obj.show();
			});
		}
		else {
			alert('magnehelic log file is required!');
			location.reload();
		}


		lr.on('line', function (line) {
			if(lineCounter == 1) {
				MeasureData.push({
					index : 1,
					date : null,
					time : null,
					pressure : parseInt(0),
					unit : 'mbar'
				});
				lineCounter++;
			} else if(line.substring(37, 41)*1 == 0) {
				// SKIP LINE IF Pressure == 0
				;
			} else if(lineCounter > 1) {
			// 	NORMAL LINE
				MeasureData.push({
					index : parseInt(line.substring(4, 6)),
					date : new Date(line.substring(8, 18)),
					time : new Date().getTime(line.substring(19, 27)),
					pressure : line.substring(37, 41)*1,
					unit : line.substring(50, 54)
				});
			}
			else {
				if(line.toString() == ' Index  ---date--- --time--      Pressure         unit') {
					lineCounter++;
				}
				else {
					alert('Invalid log file content!');
					location.reload();
				}
			}
		});
		lr.on('end', function() {
			lineCounter = 0;
			var DataSets = function(MeasureData) {

				dataSetPoss = new Array();
				dataSetNeg = new Array();

				var loopEndCounter = true;

				MeasureData.forEach(function(MeasureData) {
						if(MeasureData.pressure >= 0 && loopEndCounter) {

							this.dataSetPoss.push({
								x: MeasureData.index,
								y: MeasureData.pressure
							});

						} else {
							this.loopEndCounter == false;

							this.dataSetNeg.push({
								x: MeasureData.index,
								y: MeasureData.pressure
							});
						}
				});

				// SET INDEXES ROWS
				var count = 1;

				if(dataSetPoss.length >= dataSetNeg.length) {
					dataSetPoss.forEach(function(x) {
						x.x = count;
						count++;
					});

					count = 1;
					dataSetNeg.push({ x:1, y:0 });
					this.dataSetNeg = dataSetNeg.reverse();

					dataSetNeg.forEach(function(x) {
						if(count == 1) {
							x.x = 1;
						}
						else {
							x.x = (this.dataSetPoss.length / this.dataSetNeg.length) * count;
						}
						count++;
					});

					dataSetPoss.push({x:dataSetPoss.length + 1, y:0});
					dataSetNeg.push({x:dataSetPoss[dataSetPoss.length-1].x, y:0});

				} else {
					alert('STILL WORKING (if negative array is longer...)')
				}

				return ({dataSetPoss, dataSetNeg});

			}

			var dataSets = new DataSets(MeasureData);

			// MAKE CHART
			//Chart.defaults.global.omitXLabels = false;

			var ctx = document.getElementById("myChart");
			var scatterChart = new Chart(ctx, {
				responsive: true,
				maintainAspectRatio: false,
				type: 'line',
				data: {
					datasets: [
					{
						//label: '+',
						data: dataSets.dataSetPoss
					},
					{
						//label: null,
						data: dataSets.dataSetNeg
					}]
				},
				options: {
					// ERASE LABELS
					legend: {
						display: false
					},
					scales: {
						xAxes: [{
							type: 'linear',
							position: 'bottom'
						}]
					}
				}
			});

			form($('#header')[0], $('#footer'));
			//ctx.getContext("2d").canvas.width = 300;
			//$('canvas').css({height : $(document).height() - 80 + 'px !important'});//css({height: (});
		});

		var buttons = $('.printButtons');

		$('#gearInput').change(function(data) {
			if(data.target.value.length > 10) {
				buttonsManager.showPrintButtons(buttons);
			}
			else {
				buttonsManager.hidePrintButtons(buttons);
				alert('Įveskite aptarnaujamo reguliatoriaus modelį!');
			}
		});

		// RELOAD LISTENER
		$('canvas').dblclick(function() {
			if(confirm('OPEN NEW LOG FILE?')) {
				location.reload();
			}

    // FIX CSS footer

    // BUTTONS ACTIONS
		});

    //console.log($('#myChart')[0].width + 80 + 'px')
	
		/*
		exec('screencapture -R10,10,500,500 ./test.jpg', function (err, stdout, stderr) {
			console.dir(err, stdout, stderr)
		});
		*/
		// <<<<<<< HEAD
		/*
		var screenshot = require('desktop-screenshot');

		screenshot("screenshot.png", function(error, complete) {
			if(error)
				console.log("Screenshot failed", error);
			else
				console.log("Screenshot succeeded");
				console.log(complete)
		});
		*/
		//console.log(ipc.sendSync('synchronous-message', 'ping')) // prints "pong"

		ipcRenderer.on('asynchronous-reply', (event, arg) => {
		  try {
			console.log(arg)
		  }
		  catch(err) {
			console.log(err)
		  }
		})
		ipcRenderer.send('asynchronous-message', 'ping')

	});
  </script>
</html>
