<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
	
	<link rel="stylesheet" type="text/css" href="layout.css">
	<link rel="stylesheet" type="text/css" href="./jquery-ui.min.css">
	
	<!--<script src="./jquery.js"></script>-->
	<script type="text/javascript" src="./jquery.min.js"></script>
	<script type="text/javascript" src="./jquery-ui.min.js"></script>
	
    <title>Magnehelic</title>
  </head>
  
  <body>
  <div id='header'>
	<table id='gearData'>
		<tr>
			<td style='text-align:right'>Reguliatorius:</td>
			<td><input id='gearInput' type='text' name='enteredGear' placeholder='privalomas laukas'/></td>
		</tr>
		<tr>
			<td style='text-align:right'>Aptarnavimo data:</td>
			<td><input type="text" id="datepicker"></td>
		</tr>
		<tr>
			<td style='text-align:right'>Technikas:</td>
			<td>
				<select id='selectTechnician'>
					<option value='Gintautas Krakauskas'>Gintautas Krakauskas</option>
					<option value='Valiera'>Direktorius Valiera</option>
				</select>
			</td>
		</tr>
	</table>
	<table id='nextService'>
		<tr>
			<td>SEKANTIS APTARNAVIMAS</td>
		</tr>
		<tr id='nextServiceDate'></tr>
	</table>
	<table id='buttons'>
		<tr>
			<td><button style='display: none' id='jpgButton' class='printButtons' type="button">Print .jpg</button></td>
			<td><button style='display: none' id='pdfButton' class='printButtons' type="button">Print .pdf</button></td>
			<td><button style='display: none' id='printButton' class='printButtons' type="button">Print</button></td>
		</tr>
	</table>
  </div>
  <canvas id="myChart" width="400" height="400"></canvas>
  <table id='footer'></table>
  </body>

  <script>
    // You can also require other files to run in this process
    require('./renderer.js');
	var Chart = require('chart.js');
	var LineByLineReader = require('line-by-line');
	var form = require('./form.js');
	var {dialog} = require('electron').remote;
	var buttonsManager = require('./ButtonsHandler.js');
	
	
	dialog.showOpenDialog({properties: ['openFile', 'singleSelection']}, function(file) {
		console.log(file)
		lineCounter = 0;
		MeasureData = new Array();	
		
		if(file) {
			lr = new LineByLineReader(file[0]);
		}
		else {
			alert('magnehelic log file is required!');
			location.reload();
		}
		
		
		lr.on('line', function (line) {
			if(lineCounter == 1) {
				MeasureData.push({
					index : 1,
					date : null,
					time : null,
					pressure : parseInt(0),
					unit : 'mbar'
				});
				lineCounter++;
			} else if(line.substring(37, 41)*1 == 0) {
				// SKIP LINE IF Pressure == 0
				;
			} else if(lineCounter > 1) {
			// 	NORMAL LINE	
				MeasureData.push({
					index : parseInt(line.substring(4, 6)),
					date : new Date(line.substring(8, 18)),
					time : new Date().getTime(line.substring(19, 27)),
					pressure : line.substring(37, 41)*1,
					unit : line.substring(50, 54)
				});
			}
			else {
				if(line.toString() == ' Index  ---date--- --time--      Pressure         unit') {
					lineCounter++;
				}
				else {
					alert('Invalid log file content!');
				}
			}
		});
		lr.on('end', function() {
			lineCounter = 0;
			var DataSets = function(MeasureData) {
			
				dataSetPoss = new Array();
				dataSetNeg = new Array();
				
				var loopEndCounter = true;
				
				MeasureData.forEach(function(MeasureData) {
						if(MeasureData.pressure >= 0 && loopEndCounter) {
							
							this.dataSetPoss.push({
								x: MeasureData.index,
								y: MeasureData.pressure
							});
							
						} else {
							this.loopEndCounter == false;
							
							this.dataSetNeg.push({
								x: MeasureData.index,
								y: MeasureData.pressure
							});
						}
				});
				
				// SET INDEXES ROWS
				var count = 1;
				
				if(dataSetPoss.length >= dataSetNeg.length) {
					dataSetPoss.forEach(function(x) {
						x.x = count;
						count++;
					});
					
					count = 1;
					dataSetNeg.push({ x:1, y:0 });
					this.dataSetNeg = dataSetNeg.reverse();
					
					dataSetNeg.forEach(function(x) {
						if(count == 1) {
							x.x = 1;
						}
						else {
							x.x = (this.dataSetPoss.length / this.dataSetNeg.length) * count;
						}
						count++;
					});
					
					dataSetPoss.push({x:dataSetPoss.length + 1, y:0});
					dataSetNeg.push({x:dataSetPoss[dataSetPoss.length-1].x, y:0});
					
				} else {
					alert('STILL WORKING (if negative array is longer...)')
				}
							
				return ({dataSetPoss, dataSetNeg});
			
			}
			
			var dataSets = new DataSets(MeasureData);
			
			// MAKE CHART
			//Chart.defaults.global.omitXLabels = false;
			
			var ctx = document.getElementById("myChart");
			var scatterChart = new Chart(ctx, {
				type: 'line',
				data: {
					datasets: [
					{
						//label: '+',
						data: dataSets.dataSetPoss
					},
					{
						//label: null,
						data: dataSets.dataSetNeg
					}]
				},
				options: {
					// ERASE LABELS
					legend: {
						display: false
					},
					scales: {
						xAxes: [{
							type: 'linear',
							position: 'bottom'
						}]
					}
				}
			});
			
			form($('#header')[0], $('#footer'));
		});
		
		var buttons = $('.printButtons');
		
		$('#gearInput').change(function(data) {
			if(data.target.value.length > 10) {
				buttonsManager.showPrintButtons(buttons);
			}
			else {
				buttonsManager.hidePrintButtons(buttons);
				alert('Įveskite aptarnaujamo reguliatoriaus modelį!');
			}
		})
	});
  </script>
</html>
